<!DOCTYPE html>
<html lang="es" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrestaCarla</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="manifest" href="manifest.json">
    <style>
        /* ... (Tus estilos CSS van aquí, no cambian) ... */
        body { background-color: #212529; color: #dee2e6; } .card { border-radius: 0.75rem; background-color: #343a40; } .pendiente { border-left: 5px solid #6c757d; } .pagado { border-left: 5px solid #198754; } .vencido { border-left: 5px solid #dc3545; background-color: #5d2b31; } .summary-card { background-color: #2c3034; border: 1px solid #495057; } .toast-container { z-index: 1100; } .app-bar { background-color: #2c3034; color: #dee2e6; padding: 1rem 1.5rem; border-bottom: 1px solid #495057; display: flex; align-items: center; justify-content: space-between; font-size: 1.5rem; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); } .app-bar .brand { display: flex; align-items: center; } .app-bar i { margin-right: 0.8rem; font-size: 1.7rem; } .accordion-button { background-color: #343a40; color: #dee2e6; font-weight: bold; } .accordion-button:not(.collapsed) { background-color: #495057; color: #fff; } .accordion-button:focus { box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); } .accordion-item { background-color: #2c3034; border-color: #495057; } .fecha-pago-destacada { font-size: 1.4rem; font-weight: bold; color: #ffc107; } @keyframes flash-yellow { 0% { background-color: #493e2b; } 50% { background-color: #ffc107; color: #000; } 100% { background-color: #493e2b; } } .highlight-update { animation: flash-yellow 1.2s ease-out; }
    </style>
</head>
<body>
    <div id="auth-container" class="container vh-100 d-flex justify-content-center align-items-center"><div class="card p-4" style="max-width: 400px; width: 100%;"><h2 class="text-center mb-4"><i class="bi bi-wallet2"></i> PrestaCarla</h2><div id="auth-error" class="alert alert-danger d-none" role="alert"></div><div class="mb-3"><label for="email" class="form-label">Correo Electrónico</label><input type="email" class="form-control" id="email" placeholder="tu@correo.com"></div><div class="mb-3"><label for="password" class="form-label">Contraseña</label><input type="password" class="form-control" id="password" placeholder="Mínimo 6 caracteres"></div><div class="d-grid gap-2"><button class="btn btn-primary" onclick="handleLogin()">Iniciar Sesión</button><button class="btn btn-outline-light" onclick="handleRegister()">Registrarme</button></div><div class="text-center mt-3"><a href="#" onclick="handleForgotPassword(event)">¿Olvidaste tu contraseña?</a></div></div></div>
    
    <div id="app-container" class="d-none">
        <div class="app-bar"><div class="brand"><i class="bi bi-wallet2"></i> PrestaCarla</div><button class="btn btn-danger btn-sm" onclick="handleLogout()"><i class="bi bi-box-arrow-right"></i> Cerrar Sesión</button></div>
        <div class="container mt-4 mb-5"><div class="accordion mb-4" id="summaryAccordion"><div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSummary"><i class="bi bi-graph-up me-2"></i> Ver Resumen Financiero</button></h2><div id="collapseSummary" class="accordion-collapse collapse" data-bs-parent="#summaryAccordion"><div class="accordion-body"><div class="row text-center g-2"><div class="col-sm-4"><div class="card summary-card p-2"><div class="card-body"><h6 class="card-title text-info">Capital Activo</h6><p class="fs-5 fw-bold mb-0" id="capital-activo">S/ 0.00</p></div></div></div><div class="col-sm-4"><div class="card summary-card p-2"><div class="card-body"><h6 class="card-title text-warning">Ingreso Mensual</h6><p class="fs-5 fw-bold mb-0" id="ingreso-mensual">S/ 0.00</p></div></div></div><div class="col-sm-4"><div class="card summary-card p-2"><div class="card-body"><h6 class="card-title text-light">Préstamos Activos</h6><p class="fs-5 fw-bold mb-0" id="prestamos-activos">0</p></div></div></div></div></div></div></div></div>
            <div class="input-group mb-4"><span class="input-group-text"><i class="bi bi-search"></i></span><input type="text" class="form-control" id="search-bar" placeholder="Buscar por nombre..."></div>
            <div class="d-grid gap-2 mb-4"><button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#addEditModal" onclick="prepararModalParaAgregar()"><i class="bi bi-plus-circle"></i> Agregar Nuevo Préstamo</button></div>
            <div id="lista-deudores"><p class="text-center">Cargando datos...</p></div>
        </div>
        
        <div class="modal fade" id="addEditModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header"><h5 class="modal-title" id="modal-title"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                    <div class="modal-body">
                        <form id="add-edit-form">
                            <input type="hidden" id="deudor-id">
                            <div class="mb-3"><label for="nombre" class="form-label">Nombre</label><input type="text" class="form-control" id="nombre" required></div>
                            <div class="mb-3"><label for="apellido" class="form-label">Apellido (Opcional)</label><input type="text" class="form-control" id="apellido"></div>
                            <div class="mb-3"><label for="telefono" class="form-label">Celular (Opcional)</label><input type="tel" class="form-control" id="telefono" placeholder="Ej: 987654321"></div>
                            <div class="mb-3"><label for="cantidad" class="form-label">Cantidad Prestada (S/)</label><input type="number" step="0.01" class="form-control" id="cantidad" required></div>
                            <div class="mb-3"><label for="interes" class="form-label">Interés Mensual (S/)</label><input type="number" step="0.01" class="form-control" id="interes" required></div>
                            
                            <div class="mb-3">
                                <label class="form-label">Fecha de Pago</label>
                                <div class="row g-2">
                                    <div class="col-4"><select class="form-select" id="dia_pago" aria-label="Día"></select></div>
                                    <div class="col-5"><select class="form-select" id="mes_pago" aria-label="Mes"></select></div>
                                    <div class="col-3"><select class="form-select" id="anio_pago" aria-label="Año"></select></div>
                                </div>
                            </div>
                            </form>
                    </div>
                    <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-primary" id="guardar-btn" onclick="guardarCambios()">Guardar</button></div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="history-modal-title">Historial de Pagos</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="history-modal-body"></div></div></div></div><div class="toast-container position-fixed bottom-0 end-0 p-3"><div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true"><div class="toast-header"><strong class="me-auto" id="toast-title">Notificación</strong><button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button></div><div class="toast-body" id="toast-body"></div></div></div><div class="modal fade" id="forgotPasswordModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Recuperar Contraseña</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Ingresa tu correo electrónico y te enviaremos un enlace.</p><div class="mb-3"><label for="reset-email" class="form-label">Correo Electrónico</label><input type="email" class="form-control" id="reset-email" placeholder="tu@correo.com"></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-primary" onclick="sendResetEmail()">Enviar Enlace</button></div></div></div></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script>
        // ... (Configuración de Firebase y variables globales no cambian) ...
        const firebaseConfig = { apiKey: "AIzaSyDFu2IrRdTF_BHAaM6GzrGQhzHejGzckDY", authDomain: "gestor-cobranza-c9ade.firebaseapp.com", databaseURL: "https://gestor-cobranza-c9ade-default-rtdb.firebaseio.com", projectId: "gestor-cobranza-c9ade", storageBucket: "gestor-cobranza-c9ade.appspot.com", messagingSenderId: "697644692343", appId: "1:697644692343:web:dcb5c44b46c7c740ce6772", measurementId: "G-0CLMFD358B" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        let deudoresRef, historialRef, currentUser, deudoresCache = [], lastUpdatedKey = null;
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const listaDeudoresDiv = document.getElementById('lista-deudores');
        const searchBar = document.getElementById('search-bar');
        const modalElement = new bootstrap.Modal(document.getElementById('addEditModal'));
        const historyModalElement = new bootstrap.Modal(document.getElementById('historyModal'));
        const toastElement = new bootstrap.Toast(document.getElementById('liveToast'));
        const authErrorDiv = document.getElementById('auth-error');
        const forgotPasswordModalElement = new bootstrap.Modal(document.getElementById('forgotPasswordModal'));
        
        // ===================== INICIO SECCIÓN NUEVA =====================
        const diaSelect = document.getElementById('dia_pago');
        const mesSelect = document.getElementById('mes_pago');
        const anioSelect = document.getElementById('anio_pago');
        const mesesNombres = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

        function popularDias(year, month, selectedDay) {
            const diasPrevios = diaSelect.value || selectedDay;
            diaSelect.innerHTML = '';
            const daysInMonth = new Date(year, parseInt(month) + 1, 0).getDate();
            for (let i = 1; i <= daysInMonth; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                diaSelect.appendChild(option);
            }
            diaSelect.value = Math.min(diasPrevios, daysInMonth);
        }

        mesSelect.addEventListener('change', () => popularDias(anioSelect.value, mesSelect.value));
        anioSelect.addEventListener('change', () => popularDias(anioSelect.value, mesSelect.value));

        function popularSelectoresFecha(targetDate, mode = 'add') {
            const currentYear = targetDate.getFullYear();
            const currentMonth = targetDate.getMonth();
            const currentDay = targetDate.getDate();

            anioSelect.innerHTML = '';
            let years = new Set();
            if (mode === 'edit') {
                 years.add(currentYear - 1);
            }
            years.add(new Date().getFullYear());
            years.add(new Date().getFullYear() + 1);
             if (mode === 'edit') {
                years.add(currentYear);
            }
            Array.from(years).sort().forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                anioSelect.appendChild(option);
            });
            
            mesSelect.innerHTML = '';
            if (mode === 'add') {
                const hoy = new Date();
                const mesAnterior = new Date(hoy); mesAnterior.setMonth(hoy.getMonth() - 1);
                const mesSiguiente = new Date(hoy); mesSiguiente.setMonth(hoy.getMonth() + 1);
                const opcionesMes = [mesAnterior, hoy, mesSiguiente];
                
                opcionesMes.forEach(date => {
                    const option = document.createElement('option');
                    option.value = date.getMonth();
                    option.dataset.year = date.getFullYear();
                    option.textContent = `${mesesNombres[date.getMonth()]} ${date.getFullYear()}`;
                    mesSelect.appendChild(option);
                });
            } else { // Modo Editar: muestra todos los meses
                for (let i = 0; i < 12; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = mesesNombres[i];
                    mesSelect.appendChild(option);
                }
            }
            
            anioSelect.value = currentYear;
            mesSelect.value = currentMonth;
            popularDias(currentYear, currentMonth, currentDay);
        }

        function prepararModalParaAgregar() {
            document.getElementById('modal-title').textContent = 'Agregar Nuevo Préstamo';
            document.getElementById('add-edit-form').reset();
            document.getElementById('deudor-id').value = '';
            
            let fechaSugerida = new Date();
            fechaSugerida.setMonth(fechaSugerida.getMonth() + 1);
            
            popularSelectoresFecha(fechaSugerida, 'add');
        }

        function prepararModalParaEditar(key) {
            deudoresRef.child(key).get().then((snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    document.getElementById('modal-title').textContent = 'Editar Préstamo';
                    document.getElementById('deudor-id').value = key;
                    document.getElementById('nombre').value = data.nombre;
                    document.getElementById('apellido').value = data.apellido || '';
                    document.getElementById('telefono').value = data.telefono || '';
                    document.getElementById('cantidad').value = data.cantidad;
                    document.getElementById('interes').value = data.interes;
                    
                    const fechaExistente = new Date(data.fecha_pago + 'T00:00:00');
                    popularSelectoresFecha(fechaExistente, 'edit');
                    
                    modalElement.show();
                }
            });
        }
        
        function guardarCambios() {
            const key = document.getElementById('deudor-id').value;
            let anio = anioSelect.value;
            let mes = mesSelect.value;
            // Si estamos en modo 'add', el año puede estar en el dataset del mes
            if (mesSelect.options[mesSelect.selectedIndex] && mesSelect.options[mesSelect.selectedIndex].dataset.year) {
                anio = mesSelect.options[mesSelect.selectedIndex].dataset.year;
            }
            const dia = diaSelect.value.padStart(2, '0');
            const mesFormateado = (parseInt(mes) + 1).toString().padStart(2, '0');
            const fechaFinal = `${anio}-${mesFormateado}-${dia}`;

            const deudorData = {
                nombre: document.getElementById('nombre').value,
                apellido: document.getElementById('apellido').value,
                telefono: document.getElementById('telefono').value,
                cantidad: parseFloat(document.getElementById('cantidad').value),
                interes: parseFloat(document.getElementById('interes').value),
                fecha_pago: fechaFinal,
            };
            if (!deudorData.nombre || isNaN(deudorData.cantidad) || isNaN(deudorData.interes) || !deudorData.fecha_pago) { alert('Por favor, completa todos los campos obligatorios.'); return; }
            if (key) {
                deudoresRef.child(key).get().then(snapshot => {
                    if(snapshot.exists()){
                        deudorData.estado = snapshot.val().estado;
                        deudoresRef.child(key).update(deudorData).then(() => { modalElement.hide(); showToast('Préstamo actualizado.'); });
                    }
                });
            } else {
                deudorData.estado = 'Pendiente';
                deudoresRef.push(deudorData).then(() => { modalElement.hide(); showToast('Nuevo préstamo agregado.'); });
            }
        }
        // ====================== FIN SECCIÓN MODIFICADA ======================

        // ... (El resto de funciones no necesitan cambios) ...
        function cargarDatosDeUsuario() { /* ... */ }
        function renderDeudores(deudores) { /* ... */ }
        function pagarInteres(key) { /* ... */ }
        async function mostrarHistorial(key, nombre) { /* ... */ }
        function handleLogin() { /* ... */ }
        function handleRegister() { /* ... */ }
        function handleLogout() { /* ... */ }
        function handleForgotPassword(event) { /* ... */ }
        function sendResetEmail() { /* ... */ }
        function actualizarResumen(capital, ingreso, conteo) { /* ... */ }
        function cambiarMes(fechaString, meses) { /* ... */ }
        function retrocederUnMes(key) { /* ... */ }
        function saldarDeuda(key) { /* ... */ }
        function reabrirPrestamo(key) { /* ... */ }
        function eliminarDeudor(key) { /* ... */ }
        function showToast(message, title = 'Éxito', type = 'success') { /* ... */ }
        if ('serviceWorker' in navigator) { /* ... */ }
    </script>
</body>
</html>
