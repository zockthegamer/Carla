<!DOCTYPE html>
<html lang="es" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrestaCarla</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="manifest" href="manifest.json">
    <style>
        body { background-color: #212529; color: #dee2e6; } .card { border-radius: 0.75rem; background-color: #343a40; } .pendiente { border-left: 5px solid #6c757d; } .pagado { border-left: 5px solid #198754; } .vencido { border-left: 5px solid #dc3545; background-color: #5d2b31; } .summary-card { background-color: #2c3034; border: 1px solid #495057; } .toast-container { z-index: 1100; } .app-bar { background-color: #2c3034; color: #dee2e6; padding: 1rem 1.5rem; border-bottom: 1px solid #495057; display: flex; align-items: center; justify-content: space-between; font-size: 1.5rem; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); } .app-bar .brand { display: flex; align-items: center; } .app-bar i { margin-right: 0.8rem; font-size: 1.7rem; } .accordion-button { background-color: #343a40; color: #dee2e6; font-weight: bold; } .accordion-button:not(.collapsed) { background-color: #495057; color: #fff; } .accordion-button:focus { box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); } .accordion-item { background-color: #2c3034; border-color: #495057; } .fecha-pago-destacada { font-size: 1.4rem; font-weight: bold; color: #ffc107; } @keyframes flash-yellow { 0% { background-color: #493e2b; } 50% { background-color: #ffc107; color: #000; } 100% { background-color: #493e2b; } } .highlight-update { animation: flash-yellow 1.2s ease-out; }
    </style>
</head>
<body>
    <div id="auth-container" class="container vh-100 d-flex justify-content-center align-items-center"><div class="card p-4" style="max-width: 400px; width: 100%;"><h2 class="text-center mb-4"><i class="bi bi-wallet2"></i> PrestaCarla</h2><div id="auth-error" class="alert alert-danger d-none" role="alert"></div><div class="mb-3"><label for="email" class="form-label">Correo Electrónico</label><input type="email" class="form-control" id="email" placeholder="tu@correo.com"></div><div class="mb-3"><label for="password" class="form-label">Contraseña</label><input type="password" class="form-control" id="password" placeholder="Mínimo 6 caracteres"></div><div class="d-grid gap-2"><button class="btn btn-primary" onclick="handleLogin()">Iniciar Sesión</button><button class="btn btn-outline-light" onclick="handleRegister()">Registrarme</button></div><div class="text-center mt-3"><a href="#" onclick="handleForgotPassword(event)">¿Olvidaste tu contraseña?</a></div></div></div>
    
    <div id="app-container" class="d-none">
        <div class="app-bar"><div class="brand"><i class="bi bi-wallet2"></i> PrestaCarla</div><button class="btn btn-danger btn-sm" onclick="handleLogout()"><i class="bi bi-box-arrow-right"></i> Cerrar Sesión</button></div>
        <div class="container mt-4 mb-5"><div class="accordion mb-4" id="summaryAccordion"><div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSummary"><i class="bi bi-graph-up me-2"></i> Ver Resumen Financiero</button></h2><div id="collapseSummary" class="accordion-collapse collapse" data-bs-parent="#summaryAccordion"><div class="accordion-body"><div class="row text-center g-2"><div class="col-sm-4"><div class="card summary-card p-2"><div class="card-body"><h6 class="card-title text-info">Capital Activo</h6><p class="fs-5 fw-bold mb-0" id="capital-activo">S/ 0.00</p></div></div></div><div class="col-sm-4"><div class="card summary-card p-2"><div class="card-body"><h6 class="card-title text-warning">Ingreso Mensual</h6><p class="fs-5 fw-bold mb-0" id="ingreso-mensual">S/ 0.00</p></div></div></div><div class="col-sm-4"><div class="card summary-card p-2"><div class="card-body"><h6 class="card-title text-light">Préstamos Activos</h6><p class="fs-5 fw-bold mb-0" id="prestamos-activos">0</p></div></div></div></div></div></div></div></div>
            <div class="input-group mb-4"><span class="input-group-text"><i class="bi bi-search"></i></span><input type="text" class="form-control" id="search-bar" placeholder="Buscar por nombre..."></div>
            <div class="d-grid gap-2 mb-4"><button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#addEditModal" onclick="prepararModalParaAgregar()"><i class="bi bi-plus-circle"></i> Agregar Nuevo Préstamo</button></div>
            <div id="lista-deudores"><p class="text-center">Cargando datos...</p></div>
        </div>
        
        <div class="modal fade" id="addEditModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header"><h5 class="modal-title" id="modal-title"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                    <div class="modal-body">
                        <form id="add-edit-form">
                            <input type="hidden" id="deudor-id">
                            <div class="mb-3"><label for="nombre" class="form-label">Nombre</label><input type="text" class="form-control" id="nombre" required></div>
                            <div class="mb-3"><label for="apellido" class="form-label">Apellido (Opcional)</label><input type="text" class="form-control" id="apellido"></div>
                            <div class="mb-3"><label for="telefono" class="form-label">Celular (Opcional)</label><input type="tel" class="form-control" id="telefono" placeholder="Ej: 987654321"></div>
                            <div class="mb-3"><label for="cantidad" class="form-label">Cantidad Prestada (S/)</label><input type="number" step="0.01" class="form-control" id="cantidad" required></div>
                            <div class="mb-3"><label for="interes" class="form-label">Interés Mensual (S/)</label><input type="number" step="0.01" class="form-control" id="interes" required></div>
                            <div class="mb-3">
                                <label for="fecha_pago" class="form-label">Fecha de Pago</label>
                                <input type="date" class="form-control" id="fecha_pago" required>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-primary" id="guardar-btn" onclick="guardarCambios()">Guardar</button></div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="history-modal-title">Historial de Pagos</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="history-modal-body"></div></div></div></div><div class="toast-container position-fixed bottom-0 end-0 p-3"><div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true"><div class="toast-header"><strong class="me-auto" id="toast-title">Notificación</strong><button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button></div><div class="toast-body" id="toast-body"></div></div></div><div class="modal fade" id="forgotPasswordModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Recuperar Contraseña</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Ingresa tu correo electrónico y te enviaremos un enlace.</p><div class="mb-3"><label for="reset-email" class="form-label">Correo Electrónico</label><input type="email" class="form-control" id="reset-email" placeholder="tu@correo.com"></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-primary" onclick="sendResetEmail()">Enviar Enlace</button></div></div></div></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyDFu2IrRdTF_BHAaM6GzrGQhzHejGzckDY", authDomain: "gestor-cobranza-c9ade.firebaseapp.com", databaseURL: "https://gestor-cobranza-c9ade-default-rtdb.firebaseio.com", projectId: "gestor-cobranza-c9ade", storageBucket: "gestor-cobranza-c9ade.appspot.com", messagingSenderId: "697644692343", appId: "1:697644692343:web:dcb5c44b46c7c740ce6772", measurementId: "G-0CLMFD358B" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        let deudoresRef, historialRef, currentUser, deudoresCache = [], lastUpdatedKey = null;
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const listaDeudoresDiv = document.getElementById('lista-deudores');
        const searchBar = document.getElementById('search-bar');
        const modalElement = new bootstrap.Modal(document.getElementById('addEditModal'));
        const historyModalElement = new bootstrap.Modal(document.getElementById('historyModal'));
        const toastElement = new bootstrap.Toast(document.getElementById('liveToast'));
        const authErrorDiv = document.getElementById('auth-error');
        const forgotPasswordModalElement = new bootstrap.Modal(document.getElementById('forgotPasswordModal'));
        
        auth.onAuthStateChanged(user => { if (user) { currentUser = user; authContainer.classList.add('d-none'); appContainer.classList.remove('d-none'); deudoresRef = database.ref(`/prestamos/${user.uid}`); historialRef = database.ref(`/historialPagos/${user.uid}`); cargarDatosDeUsuario(); } else { currentUser = null; appContainer.classList.add('d-none'); authContainer.classList.remove('d-none'); deudoresRef = null; historialRef = null; } });
        searchBar.addEventListener('input', (e) => { const searchTerm = e.target.value.toLowerCase(); const deudoresFiltrados = deudoresCache.filter(deudor => (deudor.nombre.toLowerCase().includes(searchTerm) || (deudor.apellido && deudor.apellido.toLowerCase().includes(searchTerm)))); renderDeudores(deudoresFiltrados); });
        function cargarDatosDeUsuario() { if (!deudoresRef) return; deudoresRef.orderByChild('estado').on('value', (snapshot) => { const data = snapshot.val(); if (!data) { deudoresCache = []; renderDeudores([]); actualizarResumen(0, 0, 0); return; } const deudoresArray = Object.entries(data).map(([key, value]) => ({ key, ...value })); deudoresArray.sort((a, b) => { if (a.estado === 'Pendiente' && b.estado !== 'Pendiente') return -1; if (a.estado !== 'Pendiente' && b.estado === 'Pendiente') return 1; return new Date(a.fecha_pago) - new Date(b.fecha_pago); }); deudoresCache = deudoresArray; renderDeudores(deudoresCache); }); }
        function renderDeudores(deudores) { listaDeudoresDiv.innerHTML = ''; let capitalActivo = 0, ingresoMensual = 0, prestamosActivos = 0; if (deudores.length === 0) { listaDeudoresDiv.innerHTML = '<p class="text-center text-muted">No se encontraron préstamos.</p>'; } deudores.forEach((item) => { const esPendiente = item.estado === 'Pendiente'; if(esPendiente){ capitalActivo += parseFloat(item.cantidad); ingresoMensual += parseFloat(item.interes); prestamosActivos++; } const fechaPago = new Date(item.fecha_pago + 'T00:00:00'); const hoy = new Date(); hoy.setHours(0,0,0,0); let claseBorde = esPendiente ? 'pendiente' : 'pagado'; if (esPendiente && fechaPago < hoy) claseBorde = 'vencido'; const whatsappButton = item.telefono ? `<a href="https://wa.me/51${item.telefono}?text=Hola%20${encodeURIComponent(item.nombre)},%20te%20escribo%20de%20PrestaCarla%20para%20recordarte%20de%20tu%20pago%20de%20interés%20de%20S/%20${parseFloat(item.interes).toFixed(2)}.%20¡Saludos!" target="_blank" class="btn btn-outline-success btn-sm ms-2" title="Enviar WhatsApp"><i class="bi bi-whatsapp"></i></a>` : ''; const cardHTML = ` <div id="card-${item.key}" class="card mb-3 ${claseBorde}"> <div class="card-header d-flex justify-content-between align-items-center"> <span>${item.nombre} ${item.apellido || ''}</span> <div><span class="badge ${esPendiente ? (claseBorde === 'vencido' ? 'bg-danger' : 'bg-secondary') : 'bg-success'}">${item.estado}</span>${whatsappButton}</div> </div> <div class="card-body"> <div class="text-center mb-3"> <div class="text-muted small">PRÓXIMO PAGO</div> <div class="fecha-pago-destacada">${fechaPago.toLocaleDateString('es-PE', { day: 'numeric', month: 'long', year: 'numeric' })}</div> </div> <p class="card-text text-center border-top pt-2"> <strong>Capital:</strong> S/ ${parseFloat(item.cantidad).toFixed(2)} | <strong>Interés:</strong> S/ ${parseFloat(item.interes).toFixed(2)} </p> <div class="d-flex justify-content-between align-items-center mt-3"> <div class="btn-group btn-group-sm"> ${esPendiente ? `<button class="btn btn-outline-secondary" onclick="retrocederUnMes('${item.key}')" title="Retroceder un mes"><i class="bi bi-arrow-counterclockwise"></i></button><button class="btn btn-warning" onclick="pagarInteres('${item.key}')"><i class="bi bi-coin"></i> Pagar Interés</button><button class="btn btn-success" onclick="saldarDeuda('${item.key}')"><i class="bi bi-check-all"></i> Saldar Deuda</button>` : `<button class="btn btn-secondary" onclick="reabrirPrestamo('${item.key}')"><i class="bi bi-arrow-clockwise"></i> Reabrir</button>`} </div> <div> <button class="btn btn-outline-secondary btn-sm" onclick="mostrarHistorial('${item.key}', '${item.nombre}')"><i class="bi bi-clock-history"></i></button> <button class="btn btn-outline-info btn-sm" onclick="prepararModalParaEditar('${item.key}')"><i class="bi bi-pencil"></i></button> <button class="btn btn-outline-danger btn-sm" onclick="eliminarDeudor('${item.key}')"><i class="bi bi-trash"></i></button> </div> </div> </div> </div> `; listaDeudoresDiv.innerHTML += cardHTML; }); actualizarResumen(capitalActivo, ingresoMensual, prestamosActivos); if (lastUpdatedKey) { const card = document.getElementById(`card-${lastUpdatedKey}`); const fechaElement = card.querySelector('.fecha-pago-destacada'); if (fechaElement) { fechaElement.classList.add('highlight-update'); setTimeout(() => { fechaElement.classList.remove('highlight-update'); }, 1200); } lastUpdatedKey = null; } }
        function pagarInteres(key) { if (!confirm('¿Confirmar el pago del interés? La fecha avanzará un mes.')) return; const deudorRef = deudoresRef.child(key); deudorRef.get().then((snapshot) => { if(snapshot.exists()) { const deudor = snapshot.val(); const nuevaFecha = cambiarMes(deudor.fecha_pago, 1); deudorRef.update({ fecha_pago: nuevaFecha }).then(() => { historialRef.child(key).push({ fechaPago: new Date().toISOString(), monto: deudor.interes }); lastUpdatedKey = key; showToast('Se registró el pago del interés.'); }); } }); }
        
        function prepararModalParaAgregar() {
            document.getElementById('modal-title').textContent = 'Agregar Nuevo Préstamo';
            document.getElementById('add-edit-form').reset();
            document.getElementById('deudor-id').value = '';
            
            let fechaSugerida = new Date();
            fechaSugerida.setMonth(fechaSugerida.getMonth() + 1);
            
            document.getElementById('fecha_pago').value = fechaSugerida.toISOString().split('T')[0];
        }

        function prepararModalParaEditar(key) {
            deudoresRef.child(key).get().then((snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    document.getElementById('modal-title').textContent = 'Editar Préstamo';
                    document.getElementById('deudor-id').value = key;
                    document.getElementById('nombre').value = data.nombre;
                    document.getElementById('apellido').value = data.apellido || '';
                    document.getElementById('telefono').value = data.telefono || '';
                    document.getElementById('cantidad').value = data.cantidad;
                    document.getElementById('interes').value = data.interes;
                    document.getElementById('fecha_pago').value = data.fecha_pago;
                    modalElement.show();
                }
            });
        }
        
        function guardarCambios() {
            const key = document.getElementById('deudor-id').value;
            const deudorData = {
                nombre: document.getElementById('nombre').value,
                apellido: document.getElementById('apellido').value,
                telefono: document.getElementById('telefono').value,
                cantidad: parseFloat(document.getElementById('cantidad').value),
                interes: parseFloat(document.getElementById('interes').value),
                fecha_pago: document.getElementById('fecha_pago').value,
            };
            if (!deudorData.nombre || isNaN(deudorData.cantidad) || isNaN(deudorData.interes) || !deudorData.fecha_pago) { alert('Por favor, completa todos los campos obligatorios.'); return; }
            if (key) {
                deudoresRef.child(key).get().then(snapshot => {
                    if(snapshot.exists()){
                        deudorData.estado = snapshot.val().estado;
                        deudoresRef.child(key).update(deudorData).then(() => { modalElement.hide(); showToast('Préstamo actualizado.'); });
                    }
                });
            } else {
                deudorData.estado = 'Pendiente';
                deudoresRef.push(deudorData).then(() => { modalElement.hide(); showToast('Nuevo préstamo agregado.'); });
            }
        }

        async function mostrarHistorial(key, nombre) { document.getElementById('history-modal-title').textContent = `Historial de ${nombre}`; const historyBody = document.getElementById('history-modal-body'); historyBody.innerHTML = '<p>Cargando historial...</p>'; historyModalElement.show(); const snapshot = await historialRef.child(key).orderByChild('fechaPago').once('value'); if (snapshot.exists()) { historyBody.innerHTML = '<ul class="list-group"></ul>'; const ul = historyBody.querySelector('ul'); snapshot.forEach(pagoSnap => { const pago = pagoSnap.val(); const fecha = new Date(pago.fechaPago).toLocaleString('es-PE'); const li = document.createElement('li'); li.className = 'list-group-item'; li.textContent = `Pago de S/ ${parseFloat(pago.monto).toFixed(2)} registrado el ${fecha}`; ul.prepend(li); }); } else { historyBody.innerHTML = '<p class="text-center text-muted">No hay pagos registrados.</p>'; } }
        function handleLogin() { const email = document.getElementById('email').value; const password = document.getElementById('password').value; authErrorDiv.classList.add('d-none'); auth.signInWithEmailAndPassword(email, password).catch(error => { authErrorDiv.textContent = error.message; authErrorDiv.classList.remove('d-none'); }); }
        function handleRegister() { const email = document.getElementById('email').value; const password = document.getElementById('password').value; authErrorDiv.classList.add('d-none'); auth.createUserWithEmailAndPassword(email, password).catch(error => { authErrorDiv.textContent = error.message; authErrorDiv.classList.remove('d-none'); }); }
        function handleLogout() { auth.signOut(); }
        function handleForgotPassword(event) { event.preventDefault(); forgotPasswordModalElement.show(); }
        function sendResetEmail() { const email = document.getElementById('reset-email').value; if (!email) { alert('Por favor, ingresa tu correo.'); return; } auth.sendPasswordResetEmail(email).then(() => { forgotPasswordModalElement.hide(); showToast('Se ha enviado un enlace a tu correo.', 'Revisa tu bandeja de entrada'); }).catch((error) => { alert(error.message); }); }
        function actualizarResumen(capital, ingreso, conteo) { document.getElementById('capital-activo').textContent = `S/ ${capital.toFixed(2)}`; document.getElementById('ingreso-mensual').textContent = `S/ ${ingreso.toFixed(2)}`; document.getElementById('prestamos-activos').textContent = conteo; }
        function cambiarMes(fechaString, meses) { let fecha = new Date(fechaString + 'T00:00:00'); fecha.setMonth(fecha.getMonth() + meses); return fecha.toISOString().split('T')[0]; }
        function retrocederUnMes(key) { if (confirm('¿Quieres retroceder la fecha de pago a un mes antes? Esto también eliminará el último registro del historial.')) { const deudorRef = deudoresRef.child(key); deudorRef.get().then((snapshot) => { if(snapshot.exists()) { const nuevaFecha = cambiarMes(snapshot.val().fecha_pago, -1); deudorRef.update({ fecha_pago: nuevaFecha }).then(() => { historialRef.child(key).orderByChild('fechaPago').limitToLast(1).once('value', (snap) => { if(snap.exists()){ const lastKey = Object.keys(snap.val())[0]; historialRef.child(key).child(lastKey).remove(); } }); showToast('La fecha se ha retrocedido un mes.', 'Corrección'); }); } }); } }
        function saldarDeuda(key) { if (confirm('¿Confirmas que se ha pagado el capital y el interés? La deuda se marcará como saldada.')) { deudoresRef.child(key).update({ estado: 'Pagado' }).then(() => showToast('La deuda ha sido saldada.')); } }
        function reabrirPrestamo(key) { if (confirm('¿Quieres reabrir este préstamo? Volverá a estar pendiente.')) { deudoresRef.child(key).update({ estado: 'Pendiente' }).then(() => showToast('El préstamo se ha reabierto.')); } }
        function eliminarDeudor(key) { if (confirm('¿Estás segura de que quieres ELIMINAR este préstamo? Esta acción y su historial se borrarán permanentemente.')) { deudoresRef.child(key).remove().then(() => { historialRef.child(key).remove(); showToast('Préstamo eliminado permanentemente.', 'Eliminado', 'danger'); }); } }
        function showToast(message, title = 'Éxito', type = 'success') { const toastHeader = document.querySelector('#liveToast .toast-header'); document.getElementById('toast-title').textContent = title; document.getElementById('toast-body').textContent = message; toastHeader.className = 'toast-header'; if (type === 'danger') { toastHeader.classList.add('bg-danger', 'text-white'); } else { toastHeader.classList.add('bg-success', 'text-white'); } toastElement.show(); }
        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js').then(reg => console.log('SW registrado')).catch(err => console.log('Error SW', err)); }
    </script>
</body>
</html>
