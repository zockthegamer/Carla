<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Cobranza</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card { border-radius: 0.75rem; }
        .pendiente { border-left: 5px solid #dc3545; } /* Rojo */
        .pagado { border-left: 5px solid #198754; }    /* Verde */
    </style>
</head>
<body>
    <div class="container mt-4 mb-5">
        <h1 class="text-center mb-4">üìù Lista de Cobranza</h1>

        <div class="d-grid gap-2 mb-4">
            <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#addModal">
                + Agregar Nuevo Pr√©stamo
            </button>
        </div>

        <div id="lista-deudores">
            <p class="text-center">Cargando datos...</p>
        </div>
    </div>

    <div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addModalLabel">Nuevo Pr√©stamo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="add-form">
                        <div class="mb-3">
                            <label for="nombre" class="form-label">Nombre</label>
                            <input type="text" class="form-control" id="nombre" required>
                        </div>
                        <div class="mb-3">
                            <label for="apellido" class="form-label">Apellido (Opcional)</label>
                            <input type="text" class="form-control" id="apellido">
                        </div>
                        <div class="mb-3">
                            <label for="cantidad" class="form-label">Cantidad Prestada (S/)</label>
                            <input type="number" step="0.01" class="form-control" id="cantidad" required>
                        </div>
                        <div class="mb-3">
                            <label for="interes" class="form-label">Inter√©s Mensual (S/)</label>
                            <input type="number" step="0.01" class="form-control" id="interes" required>
                        </div>
                        <div class="mb-3">
                            <label for="fecha_pago" class="form-label">Fecha del Primer Pago</label>
                            <input type="date" class="form-control" id="fecha_pago" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="guardarNuevoDeudor()">Guardar Pr√©stamo</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <script>
        // ------------------ 1. CONFIGURACI√ìN DE FIREBASE (¬°YA EST√Å LISTA CON TUS DATOS!) ------------------
        const firebaseConfig = {
            apiKey: "AIzaSyDFu2IrRdTF_BHAaM6GzrGQhzHejGzckDY",
            authDomain: "gestor-cobranza-c9ade.firebaseapp.com",
            databaseURL: "https://gestor-cobranza-c9ade-default-rtdb.firebaseio.com",
            projectId: "gestor-cobranza-c9ade",
            storageBucket: "gestor-cobranza-c9ade.appspot.com",
            messagingSenderId: "697644692343",
            appId: "1:697644692343:web:dcb5c44b46c7c740ce6772",
            measurementId: "G-0CLMFD358B"
        };
        // ----------------------------------------------------------------

        // Inicializar la app de Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const deudoresRef = database.ref('/prestamos');
        const listaDeudoresDiv = document.getElementById('lista-deudores');

        // ------------------ 2. LEER Y MOSTRAR DATOS EN TIEMPO REAL ------------------
        deudoresRef.orderByChild('estado').on('value', (snapshot) => {
            listaDeudoresDiv.innerHTML = '';
            const data = snapshot.val();
            if (!data) {
                listaDeudoresDiv.innerHTML = '<p class="text-center text-muted">A√∫n no hay pr√©stamos registrados.</p>';
                return;
            }
            const deudoresArray = Object.entries(data).map(([key, value]) => ({ key, ...value }));
            deudoresArray.sort((a, b) => {
                if (a.estado === 'Pendiente' && b.estado !== 'Pendiente') return -1;
                if (a.estado !== 'Pendiente' && b.estado === 'Pendiente') return 1;
                return new Date(a.fecha_pago) - new Date(b.fecha_pago);
            });
            deudoresArray.forEach((item) => {
                const esPendiente = item.estado === 'Pendiente';
                const fechaPago = new Date(item.fecha_pago + 'T00:00:00');
                const totalPagar = (parseFloat(item.cantidad) + parseFloat(item.interes)).toFixed(2);
                const cardHTML = `
                    <div class="card mb-3 ${esPendiente ? 'pendiente' : 'pagado'}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>${item.nombre} ${item.apellido || ''}</span>
                            <span class="badge ${esPendiente ? 'bg-danger' : 'bg-success'}">${item.estado}</span>
                        </div>
                        <div class="card-body">
                            <p class="card-text">
                                <strong>Pr√≥ximo Pago:</strong> ${fechaPago.toLocaleDateString('es-PE')} <br>
                                <strong>Monto a Pagar:</strong> S/ ${totalPagar}
                            </p>
                            <div class="d-grid">
                                ${esPendiente 
                                    ? `<button class="btn btn-success" onclick="marcarPagado('${item.key}')">‚úÖ Marcar como Pagado</button>`
                                    : `<button class="btn btn-secondary" onclick="reactivar('${item.key}')">üîÑ Reactivar para Siguiente Cobro</button>`
                                }
                            </div>
                        </div>
                    </div>
                `;
                listaDeudoresDiv.innerHTML += cardHTML;
            });
        });

        // ------------------ 3. FUNCIONES PARA ACTUALIZAR Y GUARDAR DATOS ------------------
        function marcarPagado(key) {
            const deudorRef = database.ref(`/prestamos/${key}`);
            deudorRef.get().then((snapshot) => {
                if(snapshot.exists()) {
                    const deudor = snapshot.val();
                    let fechaActual = new Date(deudor.fecha_pago + 'T00:00:00');
                    fechaActual.setMonth(fechaActual.getMonth() + 1);
                    const nuevaFecha = fechaActual.toISOString().split('T')[0];
                    deudorRef.update({ estado: 'Pagado', fecha_pago: nuevaFecha });
                }
            });
        }

        function reactivar(key) {
            database.ref(`/prestamos/${key}`).update({ estado: 'Pendiente' });
        }
        
        function guardarNuevoDeudor() {
            const nombre = document.getElementById('nombre').value;
            const apellido = document.getElementById('apellido').value;
            const cantidad = parseFloat(document.getElementById('cantidad').value);
            const interes = parseFloat(document.getElementById('interes').value);
            const fecha_pago = document.getElementById('fecha_pago').value;

            if (!nombre || !cantidad || !interes || !fecha_pago) {
                alert('Por favor, completa todos los campos obligatorios.');
                return;
            }

            const nuevoDeudor = {
                nombre, apellido, cantidad, interes, fecha_pago,
                estado: 'Pendiente'
            };

            deudoresRef.push(nuevoDeudor).then(() => {
                document.getElementById('add-form').reset();
                const modalEl = document.getElementById('addModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();
            }).catch((error) => console.error("Error al guardar:", error));
        }
    </script>
</body>
</html>
