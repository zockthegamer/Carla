<!DOCTYPE html>
<html lang="es" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Cobranza</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <link rel="manifest" href="manifest.json">
    
    <style>
        body { background-color: #212529; color: #dee2e6; }
        .card { border-radius: 0.75rem; background-color: #343a40; }
        .pendiente { border-left: 5px solid #dc3545; }
        .pagado { border-left: 5px solid #198754; }
        .vencido { border-left: 5px solid #ffc107; background-color: #493e2b; }
        .summary-card { background-color: #2c3034; border: 1px solid #495057; }
        .toast-container { z-index: 1100; }
    </style>
</head>
<body>
    <div class="container mt-4 mb-5">
        <h1 class="text-center mb-4">üìù Gestor de Cobranza</h1>

        <div class="row text-center mb-4 g-2">
            <div class="col-sm-4"><div class="card summary-card p-2"><div class="card-body"><h6 class="card-title text-info">Capital Activo</h6><p class="fs-5 fw-bold mb-0" id="capital-activo">S/ 0.00</p></div></div></div>
            <div class="col-sm-4"><div class="card summary-card p-2"><div class="card-body"><h6 class="card-title text-warning">Ingreso Mensual</h6><p class="fs-5 fw-bold mb-0" id="ingreso-mensual">S/ 0.00</p></div></div></div>
            <div class="col-sm-4"><div class="card summary-card p-2"><div class="card-body"><h6 class="card-title text-light">Pr√©stamos Activos</h6><p class="fs-5 fw-bold mb-0" id="prestamos-activos">0</p></div></div></div>
        </div>

        <div class="d-grid gap-2 mb-4">
            <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#addEditModal" onclick="prepararModalParaAgregar()"><i class="bi bi-plus-circle"></i> Agregar Nuevo Pr√©stamo</button>
        </div>

        <div id="lista-deudores"><p class="text-center">Cargando datos...</p></div>
    </div>

    <div class="modal fade" id="addEditModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="modal-title"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="add-edit-form">
                        <input type="hidden" id="deudor-id">
                        <div class="mb-3"><label for="nombre" class="form-label">Nombre</label><input type="text" class="form-control" id="nombre" required></div>
                        <div class="mb-3"><label for="apellido" class="form-label">Apellido (Opcional)</label><input type="text" class="form-control" id="apellido"></div>
                        <div class="mb-3"><label for="cantidad" class="form-label">Cantidad Prestada (S/)</label><input type="number" step="0.01" class="form-control" id="cantidad" required></div>
                        <div class="mb-3"><label for="interes" class="form-label">Inter√©s Mensual (S/)</label><input type="number" step="0.01" class="form-control" id="interes" required></div>
                        <div class="mb-3"><label for="fecha_pago" class="form-label">Fecha de Pago</label><input type="date" class="form-control" id="fecha_pago" required></div>
                    </form>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-primary" id="guardar-btn">Guardar</button></div>
            </div>
        </div>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header"><strong class="me-auto" id="toast-title">Notificaci√≥n</strong><button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button></div>
            <div class="toast-body" id="toast-body"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDFu2IrRdTF_BHAaM6GzrGQhzHejGzckDY",
            authDomain: "gestor-cobranza-c9ade.firebaseapp.com",
            databaseURL: "https://gestor-cobranza-c9ade-default-rtdb.firebaseio.com",
            projectId: "gestor-cobranza-c9ade",
            storageBucket: "gestor-cobranza-c9ade.appspot.com",
            messagingSenderId: "697644692343",
            appId: "1:697644692343:web:dcb5c44b46c7c740ce6772",
            measurementId: "G-0CLMFD358B"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const deudoresRef = database.ref('/prestamos');
        const listaDeudoresDiv = document.getElementById('lista-deudores');
        const modalElement = new bootstrap.Modal(document.getElementById('addEditModal'));
        const toastElement = new bootstrap.Toast(document.getElementById('liveToast'));

        function showToast(message, title = '√âxito', type = 'success') {
            const toastHeader = document.querySelector('#liveToast .toast-header');
            document.getElementById('toast-title').textContent = title;
            document.getElementById('toast-body').textContent = message;
            toastHeader.className = 'toast-header';
            if (type === 'danger') {
                toastHeader.classList.add('bg-danger', 'text-white');
            } else {
                toastHeader.classList.add('bg-success', 'text-white');
            }
            toastElement.show();
        }

        deudoresRef.orderByChild('estado').on('value', (snapshot) => {
            listaDeudoresDiv.innerHTML = '';
            const data = snapshot.val();
            let capitalActivo = 0, ingresoMensual = 0, prestamosActivos = 0;
            if (!data) {
                actualizarResumen(0, 0, 0);
                return;
            }
            const deudoresArray = Object.entries(data).map(([key, value]) => ({ key, ...value }));
            deudoresArray.sort((a, b) => {
                if (a.estado === 'Pendiente' && b.estado !== 'Pendiente') return -1;
                if (a.estado !== 'Pendiente' && b.estado === 'Pendiente') return 1;
                return new Date(a.fecha_pago) - new Date(b.fecha_pago);
            });
            deudoresArray.forEach((item) => {
                const esPendiente = item.estado === 'Pendiente';
                const fechaPago = new Date(item.fecha_pago + 'T00:00:00');
                const hoy = new Date();
                hoy.setHours(0,0,0,0);
                let claseBorde = esPendiente ? 'pendiente' : 'pagado';
                if (esPendiente && fechaPago < hoy) claseBorde = 'vencido';
                if(esPendiente){
                    capitalActivo += parseFloat(item.cantidad);
                    ingresoMensual += parseFloat(item.interes);
                    prestamosActivos++;
                }
                const cardHTML = `
                    <div class="card mb-3 ${claseBorde}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>${item.nombre} ${item.apellido || ''}</span>
                            <span class="badge ${esPendiente ? (claseBorde === 'vencido' ? 'bg-warning' : 'bg-danger') : 'bg-success'}">${item.estado}</span>
                        </div>
                        <div class="card-body">
                            <p class="card-text">
                                <strong>Pr√≥ximo Pago:</strong> ${fechaPago.toLocaleDateString('es-PE')} <br>
                                <strong>Capital:</strong> S/ ${parseFloat(item.cantidad).toFixed(2)} | <strong>Inter√©s:</strong> S/ ${parseFloat(item.interes).toFixed(2)}
                            </p>
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="btn-group btn-group-sm">
                                    ${esPendiente 
                                        ? `<button class="btn btn-outline-secondary" onclick="retrocederUnMes('${item.key}')" title="Retroceder un mes"><i class="bi bi-arrow-counterclockwise"></i></button>
                                           <button class="btn btn-warning" onclick="pagarInteres('${item.key}')"><i class="bi bi-coin"></i> Pagar Inter√©s</button>
                                           <button class="btn btn-success" onclick="saldarDeuda('${item.key}')"><i class="bi bi-check-all"></i> Saldar Deuda</button>`
                                        : `<button class="btn btn-secondary" onclick="reabrirPrestamo('${item.key}')"><i class="bi bi-arrow-clockwise"></i> Reabrir Pr√©stamo</button>`
                                    }
                                </div>
                                <div>
                                    <button class="btn btn-outline-info btn-sm" onclick="prepararModalParaEditar('${item.key}')"><i class="bi bi-pencil"></i></button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="eliminarDeudor('${item.key}')"><i class="bi bi-trash"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                listaDeudoresDiv.innerHTML += cardHTML;
            });
            actualizarResumen(capitalActivo, ingresoMensual, prestamosActivos);
        });

        function actualizarResumen(capital, ingreso, conteo) {
            document.getElementById('capital-activo').textContent = `S/ ${capital.toFixed(2)}`;
            document.getElementById('ingreso-mensual').textContent = `S/ ${ingreso.toFixed(2)}`;
            document.getElementById('prestamos-activos').textContent = conteo;
        }

        function cambiarMes(fechaString, meses) {
            let fecha = new Date(fechaString + 'T00:00:00');
            fecha.setMonth(fecha.getMonth() + meses);
            return fecha.toISOString().split('T')[0];
        }

        function pagarInteres(key) {
            const deudorRef = database.ref(`/prestamos/${key}`);
            deudorRef.get().then((snapshot) => {
                if(snapshot.exists()) {
                    const nuevaFecha = cambiarMes(snapshot.val().fecha_pago, 1);
                    deudorRef.update({ fecha_pago: nuevaFecha }).then(() => showToast('Se registr√≥ el pago del inter√©s.'));
                }
            });
        }

        function retrocederUnMes(key) {
            if (confirm('¬øQuieres retroceder la fecha de pago a un mes antes?')) {
                const deudorRef = database.ref(`/prestamos/${key}`);
                deudorRef.get().then((snapshot) => {
                    if(snapshot.exists()) {
                        const nuevaFecha = cambiarMes(snapshot.val().fecha_pago, -1);
                        deudorRef.update({ fecha_pago: nuevaFecha }).then(() => showToast('La fecha se ha retrocedido un mes.', 'Correcci√≥n'));
                    }
                });
            }
        }
        
        function saldarDeuda(key) {
            if (confirm('¬øConfirmas que se ha pagado el capital y el inter√©s? La deuda se marcar√° como saldada.')) {
                database.ref(`/prestamos/${key}`).update({ estado: 'Pagado' }).then(() => showToast('La deuda ha sido saldada.'));
            }
        }

        function reabrirPrestamo(key) {
            if (confirm('¬øQuieres reabrir este pr√©stamo? Volver√° a estar pendiente.')) {
                database.ref(`/prestamos/${key}`).update({ estado: 'Pendiente' }).then(() => showToast('El pr√©stamo se ha reabierto.'));
            }
        }
        
        function eliminarDeudor(key) {
            if (confirm('¬øEst√°s segura de que quieres ELIMINAR este pr√©stamo? Esta acci√≥n no se puede deshacer.')) {
                database.ref(`/prestamos/${key}`).remove().then(() => showToast('Pr√©stamo eliminado permanentemente.', 'Eliminado', 'danger'));
            }
        }
        
        const deudorForm = document.getElementById('add-edit-form');
        function prepararModalParaAgregar() {
            document.getElementById('modal-title').textContent = 'Agregar Nuevo Pr√©stamo';
            deudorForm.reset();
            document.getElementById('deudor-id').value = '';
            document.getElementById('guardar-btn').onclick = guardarCambios;
        }
        function prepararModalParaEditar(key) {
            const deudorRef = database.ref(`/prestamos/${key}`);
            deudorRef.get().then((snapshot) => {
                if(snapshot.exists()) {
                    const data = snapshot.val();
                    document.getElementById('modal-title').textContent = 'Editar Pr√©stamo';
                    document.getElementById('deudor-id').value = key;
                    document.getElementById('nombre').value = data.nombre;
                    document.getElementById('apellido').value = data.apellido || '';
                    document.getElementById('cantidad').value = data.cantidad;
                    document.getElementById('interes').value = data.interes;
                    document.getElementById('fecha_pago').value = data.fecha_pago;
                    document.getElementById('guardar-btn').onclick = guardarCambios;
                    modalElement.show();
                }
            });
        }
        function guardarCambios() {
            const key = document.getElementById('deudor-id').value;
            const deudorData = {
                nombre: document.getElementById('nombre').value,
                apellido: document.getElementById('apellido').value,
                cantidad: parseFloat(document.getElementById('cantidad').value),
                interes: parseFloat(document.getElementById('interes').value),
                fecha_pago: document.getElementById('fecha_pago').value,
            };
            if (!deudorData.nombre || isNaN(deudorData.cantidad) || isNaN(deudorData.interes) || !deudorData.fecha_pago) {
                alert('Por favor, completa todos los campos obligatorios.');
                return;
            }
            if (key) {
                const deudorRef = database.ref(`/prestamos/${key}`);
                deudorRef.get().then(snapshot => {
                    if(snapshot.exists()){
                        deudorData.estado = snapshot.val().estado;
                        deudorRef.update(deudorData).then(() => {
                            modalElement.hide();
                            showToast('Pr√©stamo actualizado con √©xito.');
                        });
                    }
                });
            } else {
                deudorData.estado = 'Pendiente';
                database.ref('/prestamos').push(deudorData).then(() => {
                    modalElement.hide();
                    showToast('Nuevo pr√©stamo agregado.');
                });
            }
        }
    </script>
    
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then((registration) => console.log('Service Worker registrado con √©xito.'))
                .catch((error) => console.log('Error al registrar el Service Worker:', error));
        }
    </script>
</body>
</html>
